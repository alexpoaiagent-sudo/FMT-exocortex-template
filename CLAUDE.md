# Инструкции для всех репозиториев

> Этот файл — единый источник правил для Claude Code. Стабильные знания (FPF, различения, чеклисты, правила по типам) → memory/*.md (Слой 3).

---

## 1. Архитектура репозиториев

### Типы (4 типа)

| Тип | Критерий | Source-of-truth |
|-----|----------|-----------------|
| **Pack** | Паспорт предметной области | Да |
| **Framework** | Рамки корректности (FPF, SPF) | Да |
| **Format** | Протокол структуры репо | Да (для формата) |
| **Downstream** | Производные от Pack | Нет |

Подтипы Downstream: `instrument` (код, боты), `governance` (планы, реестры), `surface` (курсы, гайды).

> **Pack — единственный source-of-truth. Downstream меняется вслед за Pack.**

### Fallback Chain

Downstream → Pack → SPF → FPF

### Иерархия

FPF (1-й) → SPF (2-й) → Pack (3-й, знания) → Downstream (4-й, модели)

### Реестр

`DS-ops/0.OPS/REPOSITORY-REGISTRY.md`

> Детали (измерения 2-4, именование, планирование): → `memory/repo-type-rules.md`

---

## 2. Стадии сессии (Open → Work → Close)

> **Три протокола:** Open (WP Gate + Ритуал) → Work (Capture-to-Pack) → Close (фиксация).
> Пропуск Open = незапланированная работа. Пропуск Work = потерянные знания. Пропуск Close = незафиксированный результат.

### Правило Push

> В конце каждого ответа с изменениями файлов Claude **ОБЯЗАН** спросить: *«Нужно ли запушить?»*

### Протокол Open: WP Gate (блокирующее)

> **ОБЯЗАТЕЛЬНО. ДО ЛЮБОГО ДЕЙСТВИЯ по задаче.**

**Первое действие на ЛЮБОЕ задание:**

1. Прочитать MEMORY.md → секция «РП текущей недели»
2. Совпадает с РП? → Да: п. 2.2. Нет: п. 2.3.

**ЗАПРЕЩЕНО до проверки:** читать код, исследовать, планировать, вызывать агентов.

#### 2.2. Совпадает — работаем

Ссылаемся на номер РП → переходим к Ритуалу.

#### 2.3. Не совпадает — СТОП

1. «Этой задачи нет в плане на неделю.»
2. Вывести таблицу РП из MEMORY.md
3. Спросить: артефакт, формулировка РП, репо, бюджет
4. Предложить перестановку РП если бюджет ограничен
5. Дождаться подтверждения
6. Записать в MEMORY.md + `DS-strategy/current/`
7. Только после записи — начать

#### 2.4. Исключения (РП не нужен)

- Задачи ≤15 мин
- Вопросы/исследования без изменений файлов
- Экстренные баг-фиксы (пользователь говорит «срочно»)

### Протокол Open: Ритуал согласования

> После WP Gate, перед работой.

**Шаг 1.** Объявить:
> *«**Работа:** [что]. **Рабочий продукт:** [артефакт]. **Метод:** [как].»*

**Шаг 2.** Дождаться согласования.

**Шаг 3.** Определить: файлы/репо, что менять, ограничения.

**Исключения:** задачи из п. 2.4; продолжение работы над тем же РП.

### Протокол Work: Capture-to-Pack

> На каждом естественном рубеже проверяй: есть ли знание для записи?

**Рубежи:** завершена подзадача, обнаружен паттерн/антипаттерн, принято архитектурное решение.

**Алгоритм:**

1. Обнаружил паттерн, различение, метод, failure mode, правило?
2. Тест: можно использовать в другом проекте? Если да →
3. Классифицировать:

| Тип знания | Куда | Когда |
|------------|------|-------|
| Доменное (архитектура, паттерны) | Соответствующий Pack | Отложить → Close |
| Правило для всех репо (1-3 строки) | `{{WORKSPACE_DIR}}/CLAUDE.md` | Сразу |
| Правило для одного репо | `<repo>/CLAUDE.md` | Сразу |
| Крупный урок | `memory/<topic>.md` | Отложить → Close |

4. Анонсировать: *«Capture: [что] → [куда]»*
5. Мелкое + одобрено → сразу. Крупное → отложить до Close.

### Протокол Close: Закрытие сессии

> Триггер: «закрываю сессию», «всё», или РП завершён.

**Алгоритм:**

1. Собрать отложенные captures + проверить пропущенные
2. Предложить конкретные изменения (Pack, CLAUDE.md, memory)
3. Показать список → получить одобрение
4. Применить одобренные изменения
5. Обновить MEMORY.md (статус РП)
6. Зафиксировать: что сделано, что осталось
7. Закоммитить (с подтверждением)
8. Обновить `DS-strategy/current/Plan W{N}...` (статусы РП)
9. Синхронизировать backup: `memory/ + CLAUDE.md → DS-strategy/exocortex/`

**Шаблон отчёта Close:**

```
**РП:** #N — [название]
**Статус:** done / in_progress
**Сделано:** [действия]
**Captures:** [N → куда]
**Git:** закоммичено + запушено
**Осталось:** ничего / [что и почему]
```

**Чеклист Close:**

- [ ] Все изменения закоммичены и запушены
- [ ] MEMORY.md обновлён (статусы РП)
- [ ] DS-strategy/current/Plan обновлён
- [ ] Captures применены
- [ ] Backup → DS-strategy/exocortex/ синхронизирован
- [ ] Отчёт Close сформирован

Все пункты выполнены → «Сессия закрыта.» Иначе — указать, что осталось.

**Исключения:** сессия ≤15 мин, сессия-вопрос без изменений.

### Владельцы протоколов

| Протокол | Владелец | Где описан |
|----------|----------|-----------|
| Open, Work, Close | Claude Code (сессия) | Этот файл |
| Strategy Session | Стратег (launchd, Пн) | DS-strategist/prompts/strategy.md |
| Day-Plan | Стратег (launchd, Вт-Вс) | DS-strategist/prompts/day-plan.md |
| Day-Close | Стратег (ручной, по запросу) | DS-strategist/prompts/day-close.md |
| Week-Review | Стратег (launchd, Вс) | DS-strategist/prompts/week-review.md |

---

## 3. Процессы (PROCESSES.md)

### Различение

| Термин | Что | Синоним |
|--------|-----|---------|
| **Процесс** | Поток действий с ВДВ (Вход → Действие → Выход) | — |
| **Сценарий** | Межсистемный процесс (владелец меняется) | = межсистемный процесс |
| **Данные** | Входы и выходы процесса | — |

### Размещение

| Категория | Где |
|-----------|-----|
| Пользовательские сценарии | `DS-ops/PROCESSES.md` |
| Платформенные сценарии | `DS-ops/PROCESSES.md` |
| Внутренние процессы системы | `<repo>/PROCESSES.md` |

### Правило процесса (ступенчатое)

| Масштаб | Требование |
|---------|-----------|
| Баг-фикс, ≤15 мин | Не нужен |
| Изменение внутри системы | PROCESSES.md этого репо |
| Межсистемная фича | DS-ops/PROCESSES.md |
| Новая система | Сценарий + процессы + данные (ВДВ) |

---

## 4. Memory (Слой 3)

### Навигация

| Ситуация | Читай |
|----------|-------|
| Работа с Pack-репо | `memory/repo-type-rules.md` |
| Терминологическая путаница | `memory/hard-distinctions.md` |
| Нужен FPF-паттерн | `memory/fpf-reference.md` |
| Создание документа | `memory/checklists.md` |
| Детали Стратега | `DS-strategist/README.md` |

### Политика memory/

| Правило | Значение |
|---------|----------|
| Макс. файлов | ≤10 |
| Макс. строк на файл | ≤100 |
| Что хранить | Только кросс-системное (нужно в любой сессии) |
| Системно-специфичное | → `<repo>/CLAUDE.md` |

**Тест:** Нужно ли это Claude в сессии по ДРУГОМУ репо? Да → memory/. Нет → repo/CLAUDE.md.

### Backup

На Close и Day-Close: `memory/ + {{WORKSPACE_DIR}}/CLAUDE.md → DS-strategy/exocortex/`

---

## 5. Обновление этого файла

- При изменении протоколов (Open/Work/Close)
- При добавлении нового различения (компактно, 1-3 строки)
- При изменении архитектуры репозиториев
- Стабильные знания → memory/*.md, НЕ сюда

---

*Шаблон из FMT-exocortex. Настройте под свою экосистему.*
