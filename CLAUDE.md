# Инструкции для всех репозиториев

> Этот файл — единый источник правил для Claude Code. Стабильные знания (FPF, различения, чеклисты, правила по типам) → memory/*.md (Слой 3).

---

## 1. Архитектура репозиториев

### Типы (5 типов)

| Тип | Уровень принципов | Критерий | Source-of-truth |
|-----|-------------------|----------|-----------------|
| **Foundation** | 0-й (нулевые) | Транс-дисциплинарные мета-ограничения | Да |
| **Framework** | 1-й / 2-й (первые/вторые) | Рамки корректности (FPF, SPF) | Да |
| **Pack** | 2-й (вторые принципы) | Паспорт предметной области | Да |
| **Format** | 3-й (фреймворк третьих) | Протокол структуры репо | Да (для формата) |
| **Downstream** | 3-й (третьи принципы) | Производные от Pack | Нет |

Подтипы Downstream: `instrument` (код, боты), `governance` (планы, реестры), `surface` (курсы, гайды).

> **Pack — единственный source-of-truth для доменного знания. Downstream меняется вслед за Pack.**

### Синонимы (уровни принципов)

| Термин | = Уровень | Пример |
|--------|-----------|--------|
| **FPF** | первые принципы + фреймворк (бандл) | FPF |
| **SPF** | фреймворк для вторых принципов (без самих принципов) | SPF |
| **S2R** | один из фреймворков для третьих принципов | FMT-s2r |
| **ZP** | нулевые принципы (без фреймворка) | ZP |

> На третьи принципы может быть **много фреймворков** (S2R — один из них). На нулевые — фреймворк не нужен (6 принципов, слишком фундаментальны).

### Fallback Chain

Downstream (3-й) → Pack (2-й) → SPF (форма 2-го) → FPF (1-й) → ZP (0-й)

### Иерархия принципов

```
Level 0: ZP (нулевые принципы)       ← принципы, нет фреймворка
    ↓ дисциплинируют
Level 1: FPF (первые принципы)       ← принципы + фреймворк (бандл)
    ↓ ограничивают
Level 2: SPF → Pack (вторые принципы) ← фреймворк + принципы (раздельно)
    ↓ определяют
Level 3: S2R и др. → Downstream      ← фреймворки + принципы (раздельно)
```

> Полная карта иерархии: `ZP/README.md`

### Реестр


> Детали (измерения 2-4, именование, планирование): → `memory/repo-type-rules.md`

### MAPSTRATEGIC.md vs Strategy.md

| Файл | Где | Кто пишет | Что содержит |
|------|-----|-----------|-------------|
| `MAPSTRATEGIC.md` | В репо системы (`{{WORKSPACE_DIR}}/<repo>/`) | Владелец системы (разработчик, команда) | Фазы развития, идеи, горизонт — «куда двигается ЭТА система» |
| `Strategy.md` | `DS-strategy/docs/` | Стратег (агрегация + пользователь) | Общая стратегия: миссия, фокусы года, приоритеты месяца — агрегат из MAPSTRATEGIC + inbox + отчёты |

**Поток:** `MAPSTRATEGIC.md` → Стратег (session-prep) → `Strategy.md` «Текущие фазы» → strategy-session → WeekPlan.
**Обратная связь:** Когда элемент MAPSTRATEGIC взят в работу (РП создан) → Стратег обновляет MAPSTRATEGIC.md (статус фазы).

---

## 2. Стадии сессии (Open → Work → Close)

> **Три протокола:** Open (WP Gate + Ритуал) → Work (Capture-to-Pack) → Close (фиксация).
> Пропуск Open = незапланированная работа. Пропуск Work = потерянные знания. Пропуск Close = незафиксированный результат.

### Правило Push

> Если есть незапушенные коммиты — **ОБЯЗАН** спросить *«Запушить?»* и дождаться ответа.
> Push (или отказ) **ДО** отчёта Close. Отчёт — последнее действие сессии.

### Exit Protocol (ОБЯЗАТЕЛЬНО для всех агентов и ролей)

> **БЛОКИРУЮЩЕЕ.** Каждый агент/роль, завершив единицу работы, ОБЯЗАН выполнить Exit Protocol.
> Работа без Exit Protocol = работа в пустоту (результат не зафиксирован, никто не знает).

**Три обязательных шага:**

| # | Шаг | Что делать | Зачем |
|---|-----|-----------|-------|
| 1 | **Артефакт** | Зафиксировать результат (коммит, файл, запись) | Без артефакта — работа не существует |
| 2 | **Статус** | Обновить статус в трекере (WeekPlan, WP context, MEMORY.md) | Без статуса — прогресс невидим |
| 3 | **Уведомление** | Сообщить следующему в цепочке (пользователь, другой агент, Стратег) | Без уведомления — цепочка обрывается |

**Примеры по ролям:**

| Роль | Артефакт | Статус | Уведомление |
|------|----------|--------|-------------|
| **Автор контента** | Пост в `docs/` + README.md | WP-43 → done | Пользователю: «Пост написан» |
| **Стратег** | WeekPlan / DayPlan | MEMORY.md | TG через notify.sh |
| **Экстрактор** | Pack-сущности | captures.md | Пользователю: Extraction Report |
| **Claude Code (сессия)** | Коммиты + push | MEMORY.md + WeekPlan | Отчёт Close |
| **Синхронизатор** | Проекции, отчёты | Лог | TG через notify.sh |

> **Тест:** Если убрать агента из системы — узнает ли кто-то, что работа выполнена? Если нет — Exit Protocol нарушен.

### Правило Pull-before-Commit (DS-strategy)

> DS-strategy получает коммиты от бота (GitHub API), Стратега, Экстрактора и Синхронизатора.
> **ОБЯЗАТЕЛЬНЫЙ порядок при записи в DS-strategy:** `git pull --rebase` → модификация файлов → `git add` → `git commit` → `git push`.
> Нарушение порядка (commit → pull) → конфликты при rebase → потеря данных.

### Правило «Без Obsidian» (DS-strategy)

> **ЗАПРЕЩЕНО** открывать DS-strategy как Obsidian vault. Obsidian кеширует файлы и записывает их вне git, создавая неконтролируемого третьего писателя. Просмотр — через VS Code (Markdown Preview: `Cmd+Shift+V`).

### Протокол Open: WP Gate (блокирующее)

> **ОБЯЗАТЕЛЬНО. ДО ЛЮБОГО ДЕЙСТВИЯ по задаче.**

**Первое действие на ЛЮБОЕ задание:**

1. Прочитать MEMORY.md → секция «РП текущей недели»
2. Совпадает с РП? → Да: п. 2.2. Нет: п. 2.3.

**ЗАПРЕЩЕНО до проверки:** читать код, исследовать, планировать, вызывать агентов.

#### 2.2. Совпадает — работаем

Ссылаемся на номер РП → переходим к Ритуалу.

#### 2.3. Не совпадает — СТОП

1. «Этой задачи нет в плане на неделю.»
2. Вывести таблицу РП из MEMORY.md
3. Спросить: артефакт, формулировка РП, репо, бюджет
4. Предложить перестановку РП если бюджет ограничен
5. Дождаться подтверждения
6. Записать **в три места** (атомарно, все три обязательны):
   - `MEMORY.md` → таблица «РП текущей недели» (новая строка)
   - `DS-strategy/current/WeekPlan W{N}...` → таблица «Рабочие продукты» (новая строка)
   - `DS-strategy/inbox/WP-{N}-{slug}.md` → context file (если бюджет ≥2h или ≥2 сессий)
7. Только после записи во все три — начать

#### 2.4. Исключения (РП не нужен)

- Задачи ≤15 мин
- Вопросы/исследования без изменений файлов
- Экстренные баг-фиксы (пользователь говорит «срочно»)

**Правило эскалации:** Если сессия начата по исключению 2.4, но пользователь задаёт второй вопрос/задание (= работа расширяется) — предложить: *«Это перерастает в рабочий продукт. Записать отдельный РП и пройти ритуал?»*

### Зонтичные РП (Umbrella WP)

> Для систем с непрерывной работой (бот, экзокортекс) — два постоянных РП:
> - **#N-dev** (развитие) — фичи из MAPSTRATEGIC
> - **#N-debt** (техдолг) — баги, latency, cleanup
>
> Context file = живой backlog (10-20 пунктов). Done-пункты удаляются, не накапливаются. Каждую неделю в WeekPlan пишем конкретный scope (что именно на этой неделе).
>
> **Правило отсечки:** задача ≥4h или отдельный lifecycle → эпизодический РП (создаётся, делается, архивируется). Пример: Telegram Stars (#9), Feed pre-gen (#37), миграция DB (#27).

#### Issue Funnel (Воронка замечаний → WP-debt)

> Три существующих intake (уже автоматизированы):
> - `unsatisfied-questions.md` ← bot feedback (unsatisfied-report scheduler)
> - `fleeting-notes.md` ← заметки пользователя из TG (`.баг ...`)
> - `captures.md` ← code-scan (TODO/FIXME)
>
> **Triage-протокол (при открытии сессии техдолга):**
> 1. Прочитать все три intake
> 2. Прочитать WP-debt backlog (текущий приоритизированный список)
> 3. Новые замечания → категоризовать (L/C/U/I) + оценить бюджет
> 4. Предложить: что берём, что отложить, что отклонить
> 5. Одобренные → WP-debt backlog, отработанные → убрать из intake
>
> **Прямая команда:** «запиши замечание: X» → Claude пишет в fleeting-notes.md с тегом бот.

### Протокол Open: Ритуал согласования

> После WP Gate, перед работой.

**Шаг 1.** Объявить (ОБЯЗАТЕЛЬНО для каждой сессии, включая исключения §2.4):


**Шаг 2.** Дождаться согласования.

**Шаг 3.** Определить: файлы/репо, что менять, ограничения. Если в DayPlan есть ссылка на context file (`DS-strategy/inbox/WP-{N}*.md`) — прочитать его для контекста.

> **Правило критичного чтения.** Context file, WORKPLAN.md и другие планировочные документы **могут устареть** — они обновляются не каждую сессию. Иерархия доверия при противоречии: (1) реальные файлы и код, (2) документы, обновлённые после WP context (CLAUDE.md репо, PROCESSES.md, коммиты), (3) WP context file / WORKPLAN.md. При чтении: сверяй с (1) и (2), устаревшие утверждения не исполняй, а предложи обновить документ.

**Исключения (только для WP Gate, НЕ для Ритуала):** задачи из п. 2.4 освобождены от WP Gate, но Ритуал (Шаг 1 — объявление роли/метода/РП) выполняется всегда. Продолжение работы над тем же РП — повторный Ритуал не нужен.

### Протокол Work: Capture-to-Pack

> На каждом естественном рубеже проверяй: есть ли знание для записи?

**Рубежи:** завершена подзадача, обнаружен паттерн/антипаттерн, принято архитектурное решение, **реализована оптимизация** (новая константа, кеш, роутинг, staggering и т.п.).

**Алгоритм:**

1. Обнаружил паттерн, различение, метод, failure mode, правило?
2. Тест: можно использовать в другом проекте? Если да →
3. Классифицировать:

| Тип знания | Куда | Когда | Через KE? |
|------------|------|-------|-----------|
| Правило для всех репо (1-3 строки) | `{{WORKSPACE_DIR}}/CLAUDE.md` | Сразу | **Нет** (напрямую) |
| Правило для одного репо (1-3 строки) | `<repo>/CLAUDE.md` | Сразу | **Нет** (напрямую) |
| Доменное (архитектура, паттерны) | Соответствующий Pack | Отложить → Close | **Да** (KE) |
| Различение, метод, FM, WP | Соответствующий Pack | Отложить → Close | **Да** (KE) |
| Крупный урок | `memory/<topic>.md` | Отложить → Close | **Нет** (напрямую) |


4. Анонсировать: *«Capture: [что] → [куда]»*
5. Мелкое правило + одобрено → сразу. Доменное → отложить до Close → KE.

### Протокол Close: Закрытие сессии

> Триггер: «закрываю сессию», «всё», или РП завершён.

**Алгоритм:**

0. **Pull** → `cd DS-strategy && git pull --rebase` (получить последние коммиты от бота/скриптов, см. «Правило Pull-before-Commit»)
   - Собрать отложенные captures + проверить пропущенные
   - Классифицировать → маршрутизировать → формализовать → валидировать
   - Показать Extraction Report → получить одобрение
   - Применить одобренные изменения (accept → Pack/CLAUDE.md/memory)
2. Обновить MEMORY.md (статус РП)
3. Зафиксировать: что сделано, что осталось
4. Закоммитить (с подтверждением)
5. Обновить `DS-strategy/current/Plan W{N}...` (статусы РП)
6. Синхронизировать backup: `memory/ + CLAUDE.md → DS-strategy/exocortex/`
7. **WP Context File:** Если РП in_progress и ≥2 сессий → обновить/создать `DS-strategy/inbox/WP-{N}-{slug}.md`. Если РП done → переместить в `archive/wp-contexts/`.
   **Проверка:** убедиться, что РП есть в WeekPlan и MEMORY.md. Если нет — добавить (РП без строки в плане = невидимый РП).
8. **Незавершённое и идеи:** Если остались недоделки, идеи на будущее или открытые вопросы → предложить пользователю, что записать:
   - **Недоделка по текущему РП** → `DS-strategy/inbox/WP-{N}-{slug}.md` (context file, секция «Осталось»)
   - **Идея развития системы** → `<repo>/MAPSTRATEGIC.md` (новый пункт в соответствующей фазе)
   - **Новая задача (не связана с текущим РП)** → `DS-strategy/inbox/captures.md` или fleeting-notes.md

**Шаблон отчёта Close:**

```
**РП:** #N — [название]
**Статус:** done / in_progress

**Агенты:**
- **Claude Code:** [что сделал — код, файлы, коммиты]
- **Экстрактор:** [что извлёк — N кандидатов, куда / «не вызывался» / «0 кандидатов (причина)»]
- **Стратег:** [что обновил — план, контекст / «не вызывался»]

**Сделано:** [краткий итог действий]
**Captures:** [N → куда]
**Git:** закоммичено + запушено ✅
**Осталось:** ничего / [что и почему]
```

> **Правило:** Каждый агент, участвовавший в сессии, ДОЛЖЕН быть упомянут в отчёте. Если агент не вызывался — написать «не вызывался». Если вызывался, но ничего не сделал — указать причину.

**Чеклист Close:**

- [ ] Все изменения закоммичены и запушены
- [ ] MEMORY.md обновлён (статусы РП)
- [ ] DS-strategy/current/Plan обновлён
- [ ] Captures применены
- [ ] **Repo CLAUDE.md:** все `feat:` коммиты за сессию → есть ли новые константы, паттерны, правила для CLAUDE.md репо?
- [ ] **WP context:** если коммиты реализуют пункт WP-плана → пункт отмечен done, Phase синхронизирована с реальностью?
- [ ] Backup → DS-strategy/exocortex/ синхронизирован
- [ ] Context file обновлён (inbox/) или архивирован (archive/wp-contexts/)
- [ ] Отчёт Close сформирован

Все пункты ✅ → «Сессия закрыта.» Иначе — указать, что осталось.

**Исключения:** сессия ≤15 мин, сессия-вопрос без изменений.

### Владельцы протоколов

| Протокол | Владелец | Где описан |
|----------|----------|-----------|
| Open, Work, Close | Claude Code (сессия) | Этот файл |
| Session-Prep (подготовка к сессии) | Стратег (launchd, Пн 4:00) | DS-strategist/prompts/session-prep.md |
| Strategy-Session (сессия стратегирования) | Стратег (вручную, после session-prep) | DS-strategist/prompts/strategy-session.md |
| Day-Plan | Стратег (launchd, Вт-Вс 4:00) | DS-strategist/prompts/day-plan.md |
| Note-Review (разбор заметок) | Стратег (launchd, 23:00 / ручной) | DS-strategist/prompts/note-review.md |
| Day-Close | Стратег (ручной, по запросу) | DS-strategist/prompts/day-close.md |
| Week-Review | Стратег (launchd, Пн 00:00) | DS-strategist/prompts/week-review.md |


---

## 3. Процессы (PROCESSES.md)

### Различение

| Термин | Что | Синоним |
|--------|-----|---------|
| **Процесс** | ВДВ внутри одной системы (логика) | — |
| **Сервис** | Именованная точка входа в процесс (навигация) | = entry point |
| **Сценарий** | Межсистемный процесс (владелец меняется) | = межсистемный процесс |
| **Данные** | Входы и выходы процесса | — |

> Сервис = дверь, процесс = комната, сценарий = путь через здания. Подробно: `memory/hard-distinctions.md` § 11

### Размещение

| Категория | Где |
|-----------|-----|
| Внутренние процессы системы | `<repo>/PROCESSES.md` |

### Правило процесса (ступенчатое)

| Масштаб | Требование |
|---------|-----------|
| Баг-фикс, ≤15 мин | Не нужен |
| Изменение внутри системы | PROCESSES.md этого репо |
| Новая система | Сценарий + процессы + данные (ВДВ) |

---

## 4. Memory (Слой 3)

### Навигация

| Ситуация | Читай |
|----------|-------|
| Работа с Pack-репо | `memory/repo-type-rules.md` |
| Терминологическая путаница | `memory/hard-distinctions.md` |
| Нужен FPF-паттерн | `memory/fpf-reference.md` |
| Создание документа | `memory/checklists.md` |
| Архитектурное решение / SOTA | `memory/sota-reference.md` |
| Детали Стратега | `DS-strategist/README.md` |

### Политика memory/

| Правило | Значение |
|---------|----------|
| Макс. файлов | ≤10 |
| Макс. строк на файл | ≤100 |
| Что хранить | Только кросс-системное (нужно в любой сессии) |
| Системно-специфичное | → `<repo>/CLAUDE.md` |

**Тест:** Нужно ли это Claude в сессии по ДРУГОМУ репо? Да → memory/. Нет → repo/CLAUDE.md.

### Backup

На Close и Day-Close: `memory/ + {{WORKSPACE_DIR}}/CLAUDE.md → DS-strategy/exocortex/`

---

## 5. АрхГейт (ArchGate) — архитектурная оценка (ОБЯЗАТЕЛЬНАЯ)

> **БЛОКИРУЮЩЕЕ.** Любой ответ с архитектурным решением (предложение, выбор подхода, структура, паттерн) ОБЯЗАН содержать оценку по 6 характеристикам (ЭМОГСС). Без этой проработки — не давать ответ.

| Характеристика | Вопрос |
|----------------|--------|
| Эволюционируемость | Что сломается при изменении? |
| Масштабируемость | Что будет при 10x? |
| Обучаемость | Сколько читать, чтобы начать? |
| Генеративность | Создаёт ли это платформу для нового? Работает ли в шаблоне экзокортекса без дополнительных регистраций? |
| Скорость | Какая задержка для пользователя? Уложимся ли в бюджет latency (бот <3 сек, CLI <1 сек)? |
| Современность | Как эту задачу решают лучшие? Проверь `memory/sota-reference.md` на релевантные практики. |

**Формат:** Сначала решение → затем таблица оценки → затем вывод (что слабо, что менять). Если характеристика слабая — явно указать и предложить усиление.

**Чеклист современности** (при архитектурном решении — пробеги по приоритетной тройке):
1. Context Engineering (SOTA.002): Write/Select/Compress/Isolate — что попадает в контекст агента?
2. DDD Strategic (SOTA.001): BC определён? UL консистентен? Context Map есть?
3. Coupling Model (SOTA.011): оценены ли связи по 3 измерениям — knowledge, distance, volatility?

> Полный справочник: `memory/sota-reference.md` (18 практик: 12 Platform + 6 Pack Architecture)

---

## 6. Обновление этого файла

- При изменении протоколов (Open/Work/Close)
- При добавлении нового различения (компактно, 1-3 строки)
- При изменении архитектуры репозиториев
- Стабильные знания → memory/*.md, НЕ сюда

---

*Последнее обновление: 2026-02-18*
