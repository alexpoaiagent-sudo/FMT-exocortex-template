# Протокол Open (WP Gate + Ритуал)

> **Триггер:** Любое задание от пользователя. Claude читает этот файл ПЕРЕД началом работы.
> **Источник:** CLAUDE.md § 2 (slim) → этот файл.

---

## WP Gate (блокирующее)

**ОБЯЗАТЕЛЬНО. ДО ЛЮБОГО ДЕЙСТВИЯ по задаче.**

1. Прочитать MEMORY.md → секция «РП текущей недели»
2. Совпадает с РП? → Да: п. 3. Нет: СТОП.

**ЗАПРЕЩЕНО до проверки:** читать код, исследовать, планировать, вызывать агентов.

### Совпадает — работаем

Ссылаемся на номер РП → переходим к Ритуалу.

### Не совпадает — СТОП

1. «Этой задачи нет в плане на неделю.»
2. Вывести таблицу РП из MEMORY.md
3. Спросить: артефакт, формулировка РП, репо, бюджет
4. Предложить перестановку РП если бюджет ограничен
5. Дождаться подтверждения
6. Записать **в три места** (атомарно):
   - `MEMORY.md` → таблица РП (новая строка)
   - `DS-strategy/current/WeekPlan W{N}...` → таблица РП (новая строка)
   - `DS-strategy/inbox/WP-{N}-{slug}.md` → context file (если бюджет ≥2h или ≥2 сессий)
7. Только после записи во все три — начать

### Исключения (РП не нужен)

- Задачи ≤15 мин
- Вопросы/исследования без изменений файлов
- Экстренные баг-фиксы (пользователь говорит «срочно»)

**Эскалация:** Если сессия начата по исключению, но пользователь задаёт второе задание → *«Это перерастает в РП. Записать?»*

> **Урок WP Gate (2026-02-09):** Переход от исследования к действию = переход через WP Gate. Даже если исследование было исключением, момент «теперь исправь» требует полной проверки. Никогда не квалифицировать задачу как исключение самостоятельно, если результат — файлы.

---

## Ритуал согласования

> После WP Gate, перед работой.

**Шаг 1.** Объявить:
> *«**Роль:** [из каталога DP.AGENT.001 §3.2]. **Работа:** [что]. **РП:** [артефакт]. **Метод:** [как]. **Оценка:** [~Xh]. **Модель:** [текущая] — рекомендую [модель] ([причина]).»*

> Роли нет в каталоге → *«Роль не найдена. Предлагаю добавить: [название].»*

**Рекомендация модели:**
- Opus — архитектура, сложный код, multi-system изменения, стратегия
- Sonnet — типовые задачи, одно-файловые правки, написание контента
- Haiku — быстрые поиски, простые вопросы, тривиальные фиксы
- Пользователь может не согласиться и поменять модель перед началом работы

**Шаг 2.** Дождаться согласования (включая модель).

**Шаг 3.** Определить файлы/репо, ограничения. Если есть context file (`DS-strategy/inbox/WP-{N}*.md`) — прочитать.

> **Критичное чтение:** Context file может устареть. Иерархия доверия: (1) реальные файлы/код → (2) свежие документы → (3) WP context / WORKPLAN.

**Исключения:** Задачи §2.4 освобождены от WP Gate, но Ритуал (объявление) — всегда. Продолжение работы над тем же РП — повторный Ритуал не нужен.

---

## Зонтичные РП (Umbrella WP)

Для систем с непрерывной работой — два постоянных РП:
- **#N-dev** (развитие) — фичи из MAPSTRATEGIC
- **#N-debt** (техдолг) — баги, latency, cleanup

Context file = живой backlog (10-20 пунктов). Done удаляются. Каждую неделю — конкретный scope в WeekPlan.

**Отсечка:** задача ≥4h или отдельный lifecycle → эпизодический РП.

---

## Issue Funnel (Воронка → WP-debt) — v2 DB-native

**Двухуровневый триаж (R7 Триажёр):**
- **Auto-triage (Grade 1):** helpful=false / comment → Haiku classify → `feedback_triage` DB → TG alert if severity>=high
- **Review (Grade 3):** при открытии сессии техдолга → structured report + 2 файловых intake

**Источники:** `feedback_triage` DB, `unsatisfied-questions.md` (REPORT, не inbox), `fleeting-notes.md`, `captures.md`.

**Review-протокол (при открытии сессии техдолга):**
1. Прочитать unsatisfied-questions.md
2. Прочитать fleeting-notes + captures
3. Прочитать WP-debt backlog
4. Review + оценить бюджет
5. Одобренные → backlog, отработанные → `status='resolved'`

**Прямая команда:** «запиши замечание: X» → fleeting-notes.md с тегом бот.

---

## Обслуживание экзокортекса (из claude-md-maintenance.md)

| Слой | Файл | Лимит | Загрузка |
|------|------|-------|----------|
| 1 | MEMORY.md | ≤100 строк | Авто (всегда) |
| 2 | ~/Github/CLAUDE.md | ≤150 строк | Авто (всегда) |
| 3 | memory/*.md | ≤10 файлов, ≤100 строк | По триггерам |

| Контент | Куда |
|---------|------|
| Новый протокол | memory/protocol-*.md |
| Различение (1-3 строки) | CLAUDE.md (компактно) |
| Жёсткое различение | memory/hard-distinctions.md |
| Правило для типа репо | memory/repo-type-rules.md |
| Урок (кросс-системный) | memory/<topic>.md |
| Урок (одна система) | <repo>/CLAUDE.md |

> **CLAUDE.md НЕ в git.** `~/Github/` — НЕ репозиторий. Версионирование — через backup в `DS-strategy/exocortex/`.
